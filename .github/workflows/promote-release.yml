name: Promote Release Between Environments

on:
  workflow_dispatch:
    inputs:
      release_id:
        description: 'Release ID to promote'
        required: true
        type: string
      source_environment:
        description: 'Source environment'
        required: true
        type: choice
        options:
          - dev
          - staging
      target_environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production

jobs:
  validate-promotion:
    name: Validate Promotion Request
    runs-on: ubuntu-latest
    outputs:
      is_valid: ${{ steps.validate.outputs.is_valid }}
      promotion_metadata: ${{ steps.validate.outputs.metadata }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Promotion Eligibility
        id: validate
        uses: ./.github/actions/promotion-validation
        with:
          release_id: ${{ inputs.release_id }}
          source_environment: ${{ inputs.source_environment }}
          target_environment: ${{ inputs.target_environment }}

      - name: Check Validation Result
        if: steps.validate.outputs.is_valid != 'true'
        run: |
          echo "::error::Promotion validation failed"
          exit 1

  approval-gate:
    name: Approval Required for Promotion
    runs-on: ubuntu-latest
    needs: validate-promotion
    # Use GitHub environment protection rules for approval
    environment:
      name: promotion-approval-${{ inputs.target_environment }}
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Waiting for Approval
        run: |
          echo "## ðŸ” Approval Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Promotion Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Release ID: ${{ inputs.release_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- From: ${{ inputs.source_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- To: ${{ inputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Requested by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â³ Waiting for approval from authorized reviewers..." >> $GITHUB_STEP_SUMMARY

      - name: Approval Granted
        run: |
          echo "âœ… Approval granted for promotion to ${{ inputs.target_environment }}"

  pre-promotion-checks:
    name: Pre-Promotion Checks
    runs-on: ubuntu-latest
    needs: approval-gate
    outputs:
      checks_passed: ${{ steps.checks.outputs.passed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Pre-Promotion Checks
        id: checks
        uses: ./.github/actions/pre-promotion-checks
        with:
          release_id: ${{ inputs.release_id }}
          source_environment: ${{ inputs.source_environment }}
          target_environment: ${{ inputs.target_environment }}

      - name: Verify Checks Passed
        if: steps.checks.outputs.passed != 'true'
        run: |
          echo "::error::Pre-promotion checks failed"
          exit 1

  promote-release:
    name: Execute Promotion
    runs-on: ubuntu-latest
    needs: pre-promotion-checks
    environment:
      name: ${{ inputs.target_environment }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Execute Release Promotion
        id: promote
        uses: ./.github/actions/execute-promotion
        with:
          release_id: ${{ inputs.release_id }}
          source_environment: ${{ inputs.source_environment }}
          target_environment: ${{ inputs.target_environment }}

      - name: Promotion Summary
        run: |
          echo "## ðŸš€ Promotion Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Release ID: ${{ inputs.release_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Promoted From: ${{ inputs.source_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Promoted To: ${{ inputs.target_environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Approved by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment URL: ${{ steps.promote.outputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY

  post-promotion-verification:
    name: Post-Promotion Verification
    runs-on: ubuntu-latest
    needs: promote-release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Post-Promotion Tests
        uses: ./.github/actions/post-promotion-verification
        with:
          release_id: ${{ inputs.release_id }}
          environment: ${{ inputs.target_environment }}

      - name: Notify Stakeholders
        run: |
          echo "ðŸ“§ Sending promotion notification..."
          # TODO: Add notification logic (Slack, email, etc.)
          echo "Notification sent to stakeholders"

